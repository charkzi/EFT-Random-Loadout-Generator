<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>EFT Random Loadout Generator v4.1</title>
<style>
:root {
  --bg:#0b0b0b; --card:#161616; --text:#eaeaea; --button:#2a2a2a;
}
body.light { --bg:#f4f4f4; --card:#ffffff; --text:#111; --button:#ddd; }
body { background:var(--bg); color:var(--text); font-family:Arial,sans-serif; text-align:center; margin:0; padding-bottom:40px; transition:.3s; }
button { padding:14px 22px; font-size:16px; margin:6px; cursor:pointer; background:var(--button); color:var(--text); border:none; border-radius:8px; }
input { width:80%; padding:10px; margin-top:10px; background:var(--card); color:var(--text); border:1px solid #555; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; max-width:1200px; margin:20px auto; padding:0 10px; }
.item { background:var(--card); padding:12px; border-radius:10px; }
.item img { width:100%; max-height:180px; object-fit:contain; }
</style>
</head>
<body>

<h1>ğŸ¯ EFT Random Loadout</h1>

<button onclick="generateLoadout()">ğŸ”„ Neues Loadout</button>
<button onclick="generateShareLink()">ğŸ”— Share-Link</button>
<button onclick="toggleTheme()">ğŸŒ— Dark / Light</button>
<br>
<input id="shareLink" readonly placeholder="Share-Link">

<div class="grid" id="loadout"></div>

<script>
const API="https://api.tarkov.dev/graphql";
let currentLoadout=null;

// Theme
const savedTheme=localStorage.getItem("theme");
if(savedTheme==="light") document.body.classList.add("light");
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light")?"light":"dark");
}

// GraphQL Query
async function query(q){
  const res = await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({query:q})
  });
  const json = await res.json();
  if(json.errors) throw new Error(json.errors[0].message);
  return json.data;
}

const pick = arr => arr && arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;
const card = (title,item) => item ? `<div class="item"><h3>${title}</h3>${item.imageLink?`<img src="${item.imageLink}">`:''}<div>${item.name}</div></div>` : '';

// Loadout
async function generateLoadout(forced=null){
  const container = document.getElementById("loadout");
  container.innerHTML = "â³ Ladeâ€¦";

  try{
    const data = await query(`
      {
        weapons: items(types:[gun]) { name imageLink slots{name filters{allowedItems{name imageLink}}} }
        helmets: items(types:[headwear]) { name imageLink }
        masks: items(types:[faceCover]) { name imageLink }
        armors: items(types:[armor]) { name imageLink }
        rigs: items(types:[rig]) { name imageLink }
        backpacks: items(types:[backpack]) { name imageLink }
      }
    `);

    const weapon = forced?.weapon ? data.weapons.find(w=>w.name===forced.weapon) : pick(data.weapons) || {};
    const helmet = forced?.helmet ? data.helmets.find(h=>h.name===forced.helmet) : pick(data.helmets) || {};
    const mask = forced?.mask ? data.masks.find(m=>m.name===forced.mask) : pick(data.masks) || {};
    const armor = forced?.armor ? data.armors.find(a=>a.name===forced.armor) : pick(data.armors) || {};
    const rig = forced?.rig ? data.rigs.find(r=>r.name===forced.rig) : pick(data.rigs) || {};
    const backpack = forced?.backpack ? data.backpacks.find(b=>b.name===forced.backpack) : pick(data.backpacks) || {};

    // Attachments
    let attachmentsHTML = "";
    if(Array.isArray(weapon.slots)){
      weapon.slots.forEach(slot=>{
        if(slot.filters?.allowedItems?.length){
          attachmentsHTML += card(slot.name, pick(slot.filters.allowedItems));
        }
      });
    }

    currentLoadout = {
      weapon: weapon.name || "",
      helmet: helmet.name || "",
      mask: mask.name || "",
      armor: armor.name || "",
      rig: rig.name || "",
      backpack: backpack.name || ""
    };

    container.innerHTML =
      card("ğŸ”« Waffe", weapon) +
      attachmentsHTML +
      card("ğŸ¥½ Helm", helmet) +
      card("ğŸ˜· Maske", mask) +
      card("ğŸ›¡ï¸ RÃ¼stung", armor) +
      card("ğŸ’ Rig", rig) +
      card("ğŸ’ Rucksack", backpack);

  }catch(e){
    container.innerHTML = "âŒ Fehler beim Laden der Daten";
    console.error(e);
  }
}

// Share-Link
function generateShareLink(){
  if(!currentLoadout) return;
  const encoded = btoa(JSON.stringify(currentLoadout));
  const url = `${location.origin}${location.pathname}?loadout=${encoded}`;
  document.getElementById("shareLink").value = url;
}

// Load shared loadout
const params = new URLSearchParams(window.location.search);
if(params.has("loadout")){
  try{
    const decoded = JSON.parse(atob(params.get("loadout")));
    generateLoadout(decoded);
  }catch{
    generateLoadout();
  }
}
</script>

</body>
</html>
