<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>EFT Random Loadout Generator â€“ Mit Attachments</title>
<style>
:root { --bg:#0b0b0b; --card:#161616; --text:#eaeaea; --button:#2a2a2a; }
body.light { --bg:#f4f4f4; --card:#ffffff; --text:#111; --button:#ddd; }
body { background:var(--bg); color:var(--text); font-family:Arial,sans-serif; text-align:center; margin:0; padding:0 10px 40px; transition:.3s; }
button { padding:12px 18px; font-size:16px; margin:8px; cursor:pointer; background:var(--button); color:var(--text); border:none; border-radius:6px; }
input { width:90%; padding:10px; margin-top:10px; background:var(--card); color:var(--text); border:1px solid #555; border-radius:6px;}
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px; max-width:1000px; margin:20px auto; }
.item { background:var(--card); padding:10px; border-radius:8px; }
.item img { width:100%; max-height:160px; object-fit:contain; }
</style>
</head>
<body>

<h1>ğŸ¯ EFT Random Loadout</h1>

<button onclick="generateLoadout()">ğŸ”„ Neues Loadout</button>
<button onclick="generateShareLink()">ğŸ”— Share-Link</button>
<button onclick="toggleTheme()">ğŸŒ— Dark/Light</button>
<br>
<input id="shareLink" readonly placeholder="Share-Link">

<div class="grid" id="loadout"></div>

<script>
const API = "https://api.tarkov.dev/graphql";
let allItems = null;
let currentLoadout = null;

// Theme Toggle
const savedTheme = localStorage.getItem("theme");
if (savedTheme === "light") document.body.classList.add("light");
function toggleTheme() {
  document.body.classList.toggle("light");
  localStorage.setItem("theme",
    document.body.classList.contains("light") ? "light" : "dark");
}

async function fetchAllItems() {
  const res = await fetch(API, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ query: "query { items { id name shortName iconLink types slots { name filters { allowedItems { id name shortName iconLink types } } } } }" })
  });
  const json = await res.json();
  return json.data.items;
}

function pick(arr) { return arr && arr.length ? arr[Math.floor(Math.random()*arr.length)] : null; }
function card(title, item) {
  if (!item) return `<div class="item"><h3>${title}</h3><div>Keine Daten</div></div>`;
  return `<div class="item"><h3>${title}</h3>${item.iconLink?`<img src="${item.iconLink}">`:''}<div>${item.shortName||item.name||''}</div></div>`;
}
function fallbackFilter(items, types) { return items.filter(i => i.types?.some(t => types.includes(t))); }

async function generateLoadout(forced=null) {
  const container = document.getElementById("loadout");
  container.innerHTML = "â³ Lade Loadoutâ€¦";

  try {
    if (!allItems) allItems = await fetchAllItems();

    let weapons = fallbackFilter(allItems, ["gun"]);
    let helmets = fallbackFilter(allItems, ["headwear","helmet"]);
    let armors = fallbackFilter(allItems, ["armor"]);
    let rigs = fallbackFilter(allItems, ["rig"]);
    let backpacks = fallbackFilter(allItems, ["backpack"]);

    // Auswahl
    const weapon = forced?.weapon ? weapons.find(w=>w.id===forced.weapon) : pick(weapons);
    const helmet = forced?.helmet ? helmets.find(h=>h.id===forced.helmet) : pick(helmets);
    const backpack = forced?.backpack ? backpacks.find(b=>b.id===forced.backpack) : pick(backpacks);

    // Rig + Armor Konflikt
    let rig = forced?.rig ? rigs.find(r=>r.id===forced.rig) : pick(rigs);
    const isArmoredRig = rig?.name?.toLowerCase().includes("armored");
    let armor = null;
    if (!isArmoredRig) {
      armor = forced?.armor ? armors.find(a=>a.id===forced.armor) : pick(armors);
      if (armor) {
        const nonArmoredRigs = rigs.filter(r=>!r.name.toLowerCase().includes("armored"));
        rig = pick(nonArmoredRigs) || rig;
      }
    }

    // AufsÃ¤tze fÃ¼r Waffe
    let attachmentsHTML = '';
    if (weapon?.slots?.length) {
      weapon.slots.forEach(slot=>{
        const allowed = slot.filters?.allowedItems || [];
        if (allowed.length) {
          const att = pick(allowed);
          attachmentsHTML += card(slot.name, att);
        }
      });
    }

    currentLoadout = {
      weapon: weapon?.id||'',
      helmet: helmet?.id||'',
      armor: armor?.id||'',
      rig: rig?.id||'',
      backpack: backpack?.id||'',
      attachments: weapon?.slots?.map(s=>s.name)||[]
    };

    container.innerHTML =
      card("ğŸ”« Waffe", weapon) + attachmentsHTML +
      card("ğŸ¥½ Helm", helmet) +
      card("ğŸ›¡ï¸ RÃ¼stung", armor) +
      card("ğŸ’ Rig", rig) +
      card("ğŸ’ Rucksack", backpack);

  } catch(e) {
    container.innerHTML = "âŒ Fehler beim Laden der Daten â€” API liefert kein gÃ¼ltiges Ergebnis.";
    console.error(e);
  }
}

function generateShareLink() {
  if (!currentLoadout) return;
  const encoded = btoa(JSON.stringify(currentLoadout));
  const url = `${location.origin}${location.pathname}?loadout=${encoded}`;
  document.getElementById("shareLink").value = url;
}

const params = new URLSearchParams(window.location.search);
if (params.has("loadout")) {
  try { const decoded = JSON.parse(atob(params.get("loadout"))); generateLoadout(decoded); }
  catch { generateLoadout(); }
}
</script>

</body>
</html>

