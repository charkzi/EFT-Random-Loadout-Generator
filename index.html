<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>EFT Random Loadout Generator ‚Äì Offline-Fallback</title>
<style>
:root { --bg:#0b0b0b; --card:#161616; --text:#eaeaea; --button:#2a2a2a; }
body.light { --bg:#f4f4f4; --card:#ffffff; --text:#111; --button:#ddd; }
body { background:var(--bg); color:var(--text); font-family:Arial,sans-serif; text-align:center; margin:0; padding:0 10px 40px; transition:.3s; }
button { padding:12px 18px; font-size:16px; margin:8px; cursor:pointer; background:var(--button); color:var(--text); border:none; border-radius:6px; }
input { width:90%; padding:10px; margin-top:10px; background:var(--card); color:var(--text); border:1px solid #555; border-radius:6px;}
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px; max-width:1000px; margin:20px auto; }
.item { background:var(--card); padding:10px; border-radius:8px; }
.item img { width:100%; max-height:160px; object-fit:contain; }
</style>
</head>
<body>

<h1>üéØ EFT Random Loadout</h1>

<button onclick="generateLoadout()">üîÑ Neues Loadout</button>
<button onclick="generateShareLink()">üîó Share-Link</button>
<button onclick="toggleTheme()">üåó Dark/Light</button>
<br>
<input id="shareLink" readonly placeholder="Share-Link">

<div class="grid" id="loadout"></div>

<script>
let allItems = null;
let currentLoadout = null;

// Dark/Light Toggle
const savedTheme = localStorage.getItem("theme");
if(savedTheme==="light") document.body.classList.add("light");
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light")?"light":"dark");
}

// Zuf√§llige Map
const maps=["Customs","Woods","Shoreline","Interchange","The Lab","Reserve","Lighthouse"];
function pick(arr){ return arr&&arr.length?arr[Math.floor(Math.random()*arr.length)]:null; }

function card(title,item){
  if(!item) return `<div class="item"><h3>${title}</h3><div>Keine Daten</div></div>`;
  return `<div class="item"><h3>${title}</h3>${item.iconLink?`<img src="${item.iconLink}">`:''}<div>${item.shortName||item.name||''}</div></div>`;
}

function fallbackFilter(items,types){ return items.filter(i=>i.types?.some(t=>types.includes(t))); }

// Fallback-Testdaten
function loadFallbackData(){
  return [
    {id:1,name:"AK-74",caliber:"5.45x39mm",types:["gun"],iconLink:"https://i.imgur.com/6Y0Wcdq.png"},
    {id:2,name:"M4A1",caliber:"5.56x45mm",types:["gun"],iconLink:"https://i.imgur.com/3lK1QfA.png"},
    {id:3,name:"6B13 Armor",types:["armor"],iconLink:"https://i.imgur.com/XOqGHlF.png"},
    {id:4,name:"6B23 Armor",types:["armor"],iconLink:"https://i.imgur.com/8vsh6xX.png"},
    {id:5,name:"Fort Rig",types:["rig"],iconLink:"https://i.imgur.com/r0y0JQ5.png"},
    {id:6,name:"BlackRock Rig",types:["rig"],iconLink:"https://i.imgur.com/jUl9X7p.png"},
    {id:7,name:"SSh-68 Helm",types:["headwear"],iconLink:"https://i.imgur.com/RO1iH5G.png"},
    {id:8,name:"Ops-Core Helm",types:["headwear"],iconLink:"https://i.imgur.com/q2cYpM0.png"},
    {id:9,name:"MBSS Backpack",types:["backpack"],iconLink:"https://i.imgur.com/3NNcKUl.png"},
    {id:10,name:"Scav Backpack",types:["backpack"],iconLink:"https://i.imgur.com/1pVk8vB.png"},
    {id:11,name:"5.45x39mm BP",types:["ammo"],caliber:"5.45x39mm",iconLink:"https://i.imgur.com/J6EjZuD.png"},
    {id:12,name:"5.56x45mm M855",types:["ammo"],caliber:"5.56x45mm",iconLink:"https://i.imgur.com/1RmJjmu.png"}
  ];
}

// Generator
async function generateLoadout(forced=null){
  const container=document.getElementById("loadout");
  container.innerHTML="‚è≥ Lade Loadout‚Ä¶";

  try{
    if(!allItems){
      try{
        // Versuch API
        const res=await fetch("https://api.tarkov.dev/graphql",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({query:"query { items { id name shortName iconLink types caliber } }"})
        });
        const data=await res.json();
        allItems=data?.data?.items || loadFallbackData();
      }catch{
        allItems = loadFallbackData();
      }
    }

    let weapons=fallbackFilter(allItems,["gun"]);
    let helmets=fallbackFilter(allItems,["headwear","helmet"]);
    let armors=fallbackFilter(allItems,["armor"]);
    let rigs=fallbackFilter(allItems,["rig"]);
    let backpacks=fallbackFilter(allItems,["backpack"]);
    let ammos=fallbackFilter(allItems,["ammo"]);

    // üîπ Waffe zuerst
    const weapon = forced?.weapon ? weapons.find(w=>w.id===forced.weapon) : pick(weapons);

    // üîπ Passende Munition
    let ammo = null;
    if(weapon?.caliber){
      const compatibleAmmo = ammos.filter(a=>a.caliber && a.caliber.toLowerCase()===weapon.caliber.toLowerCase());
      ammo = pick(compatibleAmmo);
    }

    const helmet = forced?.helmet ? helmets.find(h=>h.id===forced.helmet) : pick(helmets);
    const backpack = forced?.backpack ? backpacks.find(b=>b.id===forced.backpack) : pick(backpacks);

    // Strikte Rig/Armor-Logik
    const armoredRigs = rigs.filter(r=>r.name.toLowerCase().includes("armored"));
    const normalRigs = rigs.filter(r=>!r.name.toLowerCase().includes("armored"));
    const heavyArmor = armors.filter(a=>a.name.toLowerCase().includes("armor"));
    const lightArmor = armors.filter(a=>!a.name.toLowerCase().includes("armor"));

    let rig = null;
    let armor = null;

    if(Math.random()<0.5){
      rig = pick(armoredRigs.concat(normalRigs));
      if(rig.name.toLowerCase().includes("armored")){
        armor = null;
      }else{
        armor = pick(heavyArmor.concat(lightArmor));
        if(armor && armor.name.toLowerCase().includes("armor")){
          rig = pick(normalRigs);
        }
      }
    }else{
      armor = pick(heavyArmor.concat(lightArmor));
      if(armor && armor.name.toLowerCase().includes("armor")){
        rig = pick(normalRigs);
      }else{
        rig = pick(armoredRigs.concat(normalRigs));
      }
    }

    const map = pick(maps);

    currentLoadout = {
      weapon: weapon?.id||'',
      helmet: helmet?.id||'',
      armor: armor?.id||'',
      rig: rig?.id||'',
      backpack: backpack?.id||'',
      ammo: ammo?.id||'',
      map: map
    };

    container.innerHTML=
      card("üî´ Waffe", weapon)+
      card("üí• Munition", ammo)+
      card("ü•Ω Helm", helmet)+
      card("üõ°Ô∏è R√ºstung", armor)+
      card("üéí Rig", rig)+
      card("üéí Rucksack", backpack)+
      `<div class="item"><h3>üó∫ Map</h3><div>${map}</div></div>`;

  }catch(e){
    container.innerHTML="‚ùå Fehler beim Laden der Daten.";
    console.error(e);
  }
}

// Share-Link
function generateShareLink(){
  if(!currentLoadout) return;
  const encoded=btoa(JSON.stringify(currentLoadout));
  const url=`${location.origin}${location.pathname}?loadout=${encoded}`;
  document.getElementById("shareLink").value=url;
}

// Load shared loadout
const params=new URLSearchParams(window.location.search);
if(params.has("loadout")){
  try{ const decoded=JSON.parse(atob(params.get("loadout"))); generateLoadout(decoded); }
  catch{ generateLoadout(); }
}
</script>

</body>
</html>
